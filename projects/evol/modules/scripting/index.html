<!doctype html><html lang=en-us>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=robots content="noodp">
<title>evol-scripting - Robear Selwans' Portfolio</title><meta name=description content="The evol game engine's scripting module."><meta property="og:title" content="evol-scripting">
<meta property="og:description" content="The evol game engine's scripting module.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://mo7sen.github.io/projects/evol/modules/scripting/"><meta property="article:section" content="projects">
<meta property="article:published_time" content="2021-07-31T13:25:00+00:00">
<meta property="article:modified_time" content="2021-07-31T13:25:00+00:00">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="evol-scripting">
<meta name=twitter:description content="The evol game engine's scripting module.">
<meta name=application-name content="Robear Selwans' Portfolio">
<meta name=apple-mobile-web-app-title content="Robear Selwans' Portfolio"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico>
<link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png>
<link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://mo7sen.github.io/projects/evol/modules/scripting/><link rel=prev href=https://mo7sen.github.io/projects/evol/modules/world/><link rel=next href=https://mo7sen.github.io/projects/evol/modules/renderer/><link rel=stylesheet href=/css/page.min.css><link rel=stylesheet href=/css/home.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"evol-scripting","inLanguage":"en-us","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/mo7sen.github.io\/projects\/evol\/modules\/scripting\/"},"genre":"projects","keywords":"Game Engine","wordcount":984,"url":"https:\/\/mo7sen.github.io\/projects\/evol\/modules\/scripting\/","datePublished":"2021-07-31T13:25:00+00:00","dateModified":"2021-07-31T13:25:00+00:00","publisher":{"@type":"Organization","name":"Robear Selwans"},"author":{"@type":"Person","name":"Robear Selwans"},"description":"The evol game engine's scripting module."}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script>(window.localStorage&&localStorage.getItem('theme')?localStorage.getItem('theme')==='dark':''==='auto'?window.matchMedia('(prefers-color-scheme: dark)').matches:''==='dark')&&document.body.setAttribute('theme','dark')</script>
<div id=mask></div><div class=wrapper><header class=desktop id=header-desktop>
<div class=header-wrapper>
<div class=header-title>
<a href=/ title="Robear Selwans' Portfolio">Robear Selwans' Portfolio</a>
</div>
<div class=menu>
<div class=menu-inner><a class=menu-item href=/about/> About </a><a class=menu-item href=/categories/project/> Projects </a><a class=menu-item href=/categories/post/> Posts </a><a class=menu-item href=/categories/> Categories </a><a class=menu-item href=/tags/> Tags </a><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw"></i>
</a>
</div>
</div>
</div>
</header><header class=mobile id=header-mobile>
<div class=header-container>
<div class=header-wrapper>
<div class=header-title>
<a href=/ title="Robear Selwans' Portfolio">Robear Selwans' Portfolio</a>
</div>
<div class=menu-toggle id=menu-toggle-mobile>
<span></span><span></span><span></span>
</div>
</div>
<div class=menu id=menu-mobile><a class=menu-item href=/about/ title>About</a><a class=menu-item href=/categories/project/ title>Projects</a><a class=menu-item href=/categories/post/ title>Posts</a><a class=menu-item href=/categories/ title>Categories</a><a class=menu-item href=/tags/ title>Tags</a><div class=menu-item><a href=javascript:void(0); class=theme-switch title="Switch Theme">
<i class="fas fa-adjust fa-fw"></i>
</a>
</div></div>
</div>
</header><main class=main>
<div class=container><div class=toc id=toc-auto style=top:8rem>
<h2 class=toc-title>Contents</h2>
<div class=toc-content id=toc-content-auto></div>
</div><article class="page single special" data-toc=disable><h2 class="single-title animated fadeInDown faster">evol-scripting</h2><div class=single-card><div class="details toc" id=toc-static data-kept>
<div class="details-summary toc-title">
<span>Contents</span>
<span><i class="details-icon fas fa-angle-right"></i></span>
</div>
<div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents></nav></div>
</div><div class=content id=content><p>The scripting module was written in a way that makes it as flexible and as
accessible as possible for all modules that might need it. First of all,
“Game World” systems were created to allow the running of per-frame update
functions that could be written in scripts. This meant that systems will only
need to run for entities that have those script functions without needing to
iterate over all entities to check.</p>
<p>To make extending this functionality substantially simpler, a lot of
pre-processor macros were added to that file so that adding a new system for a
new script function is just a matter of adding an extra line to the file and it
should handle everything else. For example, adding an <code>on_fixedupdate</code> function
to the scripting module is as simple as changing this:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=cp>#define SCRIPT_CALLBACK_FUNCTIONS() \
</span><span class=cp>  SCRIPT_OP(on_init)                \
</span><span class=cp>  SCRIPT_OP(on_update)
</span></code></pre></td></tr></table>
</div>
</div><p>to this:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=cp>#define SCRIPT_CALLBACK_FUNCTIONS() \
</span><span class=cp>  SCRIPT_OP(on_init)                \
</span><span class=cp>  SCRIPT_OP(on_update)              \
</span><span class=cp>  SCRIPT_OP(on_fixedupdate)
</span></code></pre></td></tr></table>
</div>
</div><p>However, after a few runs, it was noticeable that having the scripts be run in
a system meant that it had a few limitations when it came to editing, removing
or adding new entities into the scene. Since the ECS world uses the archetype
approach for the storage of components, the addition and removal of components
to an entity means that this entity will belong to another archetype and thus
needs to be moved to another table. Because of that, the addition of removal of
components to entities is prohibited in the phase where systems are ran as
these additions might change the tables on which the system is iterating.
That’s why we came up with the concept of a task.</p>
<p>A task is a lot like a system, it takes a component signature, matches with all
entities that fulfill that signature and iterates over all of them. The main
difference, though, is that a task is not run in the system phase of the ECS
world; tasks are run when the ECS is in an idle state and thus is open to big
changes in its tables. This allowed us to have more world-changing operations
that can run in the scripts, like the loading of prefabs.</p>
<p>Then, lots of functions were exposed from the scripting module to allow the
addition of script components to a “Game World” entity without needing to get
into much detail from other modules. This way, a script can be added to an
entity as follows:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=n>ScriptHandle</span> <span class=n>playerScript</span> <span class=o>=</span> <span class=n>Script</span><span class=o>-&gt;</span><span class=n>new</span><span class=p>(</span><span class=s>&#34;PlayerScript&#34;</span><span class=p>,</span> <span class=n>loadedScript</span><span class=p>);</span>
<span class=n>Script</span><span class=o>-&gt;</span><span class=n>addToEntity</span><span class=p>(</span><span class=n>player</span><span class=p>,</span> <span class=n>playerScript</span><span class=p>);</span>
</code></pre></td></tr></table>
</div>
</div><p>Having extensible script callbacks and the ability to attach scripts entities
is an important thing but now we have no way of exposing module-specific
functions to those scripts; which is why the <code>ScriptInterface</code> namespace was
created. This namespace’s main purpose was to allow modules to register
whatever they want to expose to modules, like: types, functions, structs, ..etc.
The <code>ScriptInterface</code> consisted of the following operations:</p>
<table>
<thead>
<tr>
<th>Function</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>addType</code></td>
<td>Creates a Lua type from a given type name and a given type size</td>
</tr>
<tr>
<td><code>getType</code></td>
<td>Get the identifier of a type using a given name</td>
</tr>
<tr>
<td><code>addFunction</code></td>
<td>Expose a function to Lua using its name, its reference, and a list of the arguments that it expects</td>
</tr>
<tr>
<td><code>addStruct</code></td>
<td>Expose a struct to Lua using its typename, its size, and a list of its parameters’ names and their types</td>
</tr>
<tr>
<td><code>loadAPI</code></td>
<td>Takes a file path that points to a Lua file that contains the description of the API that the module wants to expose. (This gives modules the ability to tweak their scripting APIs freely without needing the Scripting Module to intervene.)</td>
</tr>
</tbody>
</table>
<p>While the <code>loadAPI(..)</code> function might seem redundant, it was added for a very
specific reason. The <code>addFunction(..)</code> function does indeed expose module
functions, but in its own way. For example, exposing a function by doing this:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=n>GameObject</span> <span class=nf>ev_sceneloader_loadprefab</span><span class=p>(</span><span class=n>string</span> <span class=n>path</span><span class=p>);</span>
<span class=n>ScriptInterface</span><span class=o>-&gt;</span><span class=n>addFunction</span><span class=p>(</span><span class=n>ev_sceneloader_loadprefab</span><span class=p>,</span> <span class=s>&#34;ev_sceneloader_loadprefab&#34;</span><span class=p>,</span> <span class=n>gameObjType</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=p>(</span><span class=n>ScriptType</span><span class=p>[]){</span><span class=n>stringType</span><span class=p>});</span>
</code></pre></td></tr></table>
</div>
</div><p>will expose it to Lua in a way that makes it callable by doing the following:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=n>prefab</span> <span class=o>=</span> <span class=n>C</span><span class=p>(</span><span class=err>&#39;</span><span class=n>ev_sceneloader_loadprefab</span><span class=err>&#39;</span><span class=p>,</span> <span class=n>path</span><span class=p>)</span>
</code></pre></td></tr></table>
</div>
</div><p>That grows inconvenient quite fast, however, by having an API-defining Lua
file, the Lua file can contain something like:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-lua data-lang=lua><span class=kr>function</span> <span class=nf>loadPrefab</span><span class=p>(</span><span class=n>path</span><span class=p>)</span>
  <span class=kr>return</span> <span class=n>C</span><span class=p>(</span><span class=s1>&#39;ev_sceneloader_loadprefab&#39;</span><span class=p>,</span> <span class=n>path</span><span class=p>)</span>
<span class=kr>end</span>
</code></pre></td></tr></table>
</div>
</div><p>and the previous line can be written as:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-lua data-lang=lua><span class=n>prefab</span> <span class=o>=</span> <span class=n>loadPrefab</span><span class=p>(</span><span class=n>path</span><span class=p>)</span>
</code></pre></td></tr></table>
</div>
</div><p>After all of that was done, it was time for the module to move on from being a
singleton and start to become more instantiatable. This is where a script
context comes into play. A script context is a type that we defined that
contained some info about itself and the Lua VM that it contains. The fact that
each context had its own VM had solid reasons; the most important one is that
Lua has everything as global by default. That meant that name collisions were a
lot more probable and that objects would be able to access other objects from
other scenes; that’s why each context had its own VM.</p>
<p>However, having every context have its own VM means that types and functions
will need to be registered for each of these contexts separately. So we decided
to add script context creation callback functions, functions that are called
and passed the context whenever a new context is created. This allows modules
that want to register their own types to just create that callback and pass it
to the scripting module so that it can store it. Then, whenever a new context
is created, the scripting module calls all the callback functions that it has
stored from different modules and thus rebuilds the API for that context.</p>
<p>One last thing that remained was to make the debugging of scripts a bit more
systematic. That’s why we integrated
<a href=https://github.com/slembcke/debugger.lua target=_blank rel="noopener noreffer">luadbg</a> into the scripting module.
luadbg helped us by making a debugger kick in whenever occurs in a script (or
whenever we call a function that signals the debugger) so that we can inspect
the state of the Lua VM at that specific point in time.</p>
</div><div class=post-footer id=post-footer>
<div class=post-info><div class=post-info-tag><span><a href=/tags/game-engine/>Game Engine</a>
</span></div><div class=post-info-line><div class=post-info-mod>
<span>Updated on 2021-07-31</span>
</div><div class=post-info-mod></div>
</div><div class=post-info-share>
<span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=https://mo7sen.github.io/projects/evol/modules/scripting/ data-title=evol-scripting data-via=mo7sener data-hashtags="Game Engine"><i class="fab fa-twitter fa-fw"></i></a><a href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=https://mo7sen.github.io/projects/evol/modules/scripting/ data-hashtag="Game Engine"><i class="fab fa-facebook-square fa-fw"></i></a><a href=javascript:void(0); title="Share on Reddit" data-sharer=reddit data-url=https://mo7sen.github.io/projects/evol/modules/scripting/><i class="fab fa-reddit fa-fw"></i></a></span>
</div></div><div class=post-nav><a href=/projects/evol/modules/world/ class=prev rel=prev title=evol-world><i class="fas fa-angle-left fa-fw"></i>Previous Post</a>
<a href=/projects/evol/modules/renderer/ class=next rel=next title=evol-renderer>Next Post<i class="fas fa-angle-right fa-fw"></i></a></div></div>
</div></article></div>
</main>
<footer class=footer><div class=footer-container><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2021</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=https://mo7sen.github.io/about>Robear Selwans</a></span></div>
</div>
</footer>
</div>
<div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top">
<i class="fas fa-chevron-up fa-fw"></i>
</a></div><link rel=stylesheet href=/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/lib/animate/animate.min.css><script src=/lib/lazysizes/lazysizes.min.js></script><script src=/lib/clipboard/clipboard.min.js></script><script src=/lib/sharer/sharer.min.js></script><script>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:10},comment:{}}</script><script src=/js/theme.min.js></script></body></html>